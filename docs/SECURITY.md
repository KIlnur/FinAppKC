# Чеклист безопасности

## Обзор

Чеклист безопасности для production-развёртывания FinAppKC.

## Текущая конфигурация безопасности (разработка)

| Функция | Статус | Описание |
|---------|--------|----------|
| Регистрация | Отключена | Пользователи создаются только администратором |
| Сброс пароля | Отключён | Сброс пароля по email отключён |
| Защита от перебора | Включена | failureFactor=5, ожидание=900с |
| Политика паролей | Настроена | длина(8), цифры, заглавные, строчные, спецсимволы |
| MFA: TOTP | Условный | Настраивается пользователем, проверяется при логине |
| MFA: Passkeys | Включён | WebAuthn Passwordless, верификация пользователя preferred |
| Социальный логин | Только привязка | Google OAuth, только привязка (не регистрация) |
| SMTP | MailHog (разработка) | Реальный SMTP в production |

## Чеклист перед развёртыванием

### 1. Управление секретами

- [ ] Изменить учётные данные администратора (не `admin/admin`)
- [ ] Сгенерировать сильные пароли для всех сервисов
- [ ] Использовать менеджер секретов (Vault, AWS Secrets Manager, K8s Secrets)
- [ ] Настроить ротацию секретов
- [ ] Проверить `.gitignore` — нет секретов в репозитории

```powershell
# Генерация сильного пароля
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }) -as [byte[]])
```

### 2. Конфигурация TLS

- [ ] Только TLS 1.3
- [ ] Валидные сертификаты (Let's Encrypt или корпоративный CA)
- [ ] HSTS включён
- [ ] Закрепление сертификата для критичных клиентов (опционально)

```
# keycloak.conf для TLS
https-certificate-file=/path/to/server.crt
https-certificate-key-file=/path/to/server.key
https-protocols=TLSv1.3
https-cipher-suites=TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256
```

### 3. Сетевая безопасность

- [ ] Правила файрвола — ограничить доступ к портам
- [ ] Приватная сеть для базы данных и внутренних сервисов
- [ ] Ограничение частоты запросов на уровне балансировщика
- [ ] Защита от DDoS

```
# Порты в production
443/tcp  - HTTPS (публичный)
9001/tcp - Keycloak Management (только внутренний)
5432/tcp - PostgreSQL (только внутренний)
```

### 4. Конфигурация Keycloak

- [ ] Защита от перебора включена
- [ ] Политика паролей настроена
- [ ] Таймауты сессий оптимизированы
- [ ] CORS ограничен допустимыми origins
- [ ] Строгая валидация Redirect URI
- [ ] Неиспользуемые потоки/клиенты удалены

### 5. Безопасность базы данных

- [ ] Отдельный пользователь для Keycloak (не admin)
- [ ] Минимальные права
- [ ] SSL для PostgreSQL
- [ ] Регулярные бэкапы с шифрованием
- [ ] Лимиты пула соединений

### 6. Заголовки и CSP

- [ ] Content-Security-Policy настроен
- [ ] X-Content-Type-Options: nosniff
- [ ] X-Frame-Options: DENY или SAMEORIGIN
- [ ] Referrer-Policy: no-referrer
- [ ] Strict-Transport-Security

### 7. Логирование и мониторинг

- [ ] Структурированное логирование включено (JSON)
- [ ] Аудит-события записываются (AuditEventListener)
- [ ] Политика хранения логов
- [ ] Алертинг на подозрительную активность

```yaml
# Подозрительные события для алертов
- Множественные LOGIN_ERROR с одного IP
- Необычные паттерны ADMIN_EVENT
- Высокая частота запросов токенов
```

### 8. Безопасность плагинов

- [ ] Валидация входных данных во всех плагинах
- [ ] Нет чувствительных данных в логах
- [ ] Ограничение частоты запросов (OTP-аутентификатор)
- [ ] Обработка ошибок не раскрывает детали

### 9. Безопасность тем

- [ ] Совместимость с CSP
- [ ] Предотвращение XSS — корректное экранирование
- [ ] Использование CSRF-токенов
- [ ] Нет чувствительных данных в клиентском коде

## После развёртывания

### Регулярные задачи

- [ ] Сканирование уязвимостей (еженедельно)
- [ ] Обновление зависимостей (ежемесячно)
- [ ] Ревизия доступов (ежеквартально)
- [ ] Тестирование на проникновение (ежегодно)
- [ ] Тест восстановления из бэкапа (ежеквартально)

### Реагирование на инциденты

1. **Обнаружение** — мониторинг и алерты
2. **Локализация** — изоляция затронутых систем
3. **Расследование** — анализ логов
4. **Устранение** — исправление уязвимости
5. **Разбор** — документирование и улучшения

## Маппинг OWASP Top 10

| Риск OWASP | Меры защиты |
|------------|-------------|
| A01 Нарушение контроля доступа | RBAC, управление сессиями, CORS |
| A02 Криптографические ошибки | TLS 1.3, сильные алгоритмы, управление секретами |
| A03 Инъекции | Валидация входных данных, параметризованные запросы |
| A04 Небезопасный дизайн | Моделирование угроз, требования безопасности |
| A05 Ошибки конфигурации | Чеклист безопасности, автоматические проверки |
| A06 Уязвимые компоненты | Сканирование зависимостей, обновления |
| A07 Ошибки аутентификации | MFA, ограничение частоты запросов, политики паролей |
| A08 Целостность ПО и данных | Подписанные артефакты, безопасность CI/CD |
| A09 Ошибки логирования | Структурированное логирование, мониторинг |
| A10 SSRF | Валидация URL, сегментация сети |
